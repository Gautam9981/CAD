<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAD Macro Runner</title>
    <link rel="stylesheet" href="api-board.css">
    <style>
        .macro-upload-zone {
            border: 3px dashed var(--border-color);
            border-radius: var(--radius-lg);
            padding: 3rem;
            text-align: center;
            background: var(--bg-secondary);
            transition: all 0.3s ease;
            cursor: pointer;
            margin: 2rem 0;
        }

        .macro-upload-zone:hover,
        .macro-upload-zone.drag-over {
            border-color: var(--accent-primary);
            background: var(--bg-tertiary);
            transform: translateY(-2px);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        .macro-list {
            display: grid;
            gap: 1rem;
            margin: 2rem 0;
        }

        .macro-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .macro-card:hover {
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }

        .macro-info h3 {
            margin: 0 0 0.5rem 0;
            color: var(--accent-primary);
            font-family: var(--font-mono);
        }

        .macro-meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .macro-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.6rem 1.25rem;
            border-radius: var(--radius-sm);
            border: none;
            font-family: var(--font-body);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: var(--text-primary);
        }

        .btn-primary:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .executor-output {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin: 2rem 0;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }

        .executor-output.active {
            display: block;
        }

        .log-line {
            margin: 0.25rem 0;
            padding: 0.25rem 0;
        }

        .log-success {
            color: var(--accent-success);
        }

        .log-error {
            color: var(--accent-error);
        }

        .log-info {
            color: var(--text-secondary);
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin: 1rem 0;
            display: none;
        }

        .progress-bar.active {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-primary);
            transition: width 0.3s ease;
            width: 0%;
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="header-content">
            <h1 class="logo">
                <span class="logo-icon">‚öôÔ∏è</span>
                CAD Macro Runner
            </h1>
            <div class="header-stats">
                <span class="stat" id="macroCount">0 Macros Loaded</span>
            </div>
        </div>
    </header>

    <div class="content" style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
        <!-- Upload Zone -->
        <div class="macro-upload-zone" id="uploadZone">
            <div class="upload-icon">üì§</div>
            <h2>Upload Macro File</h2>
            <p>Drag & drop a .macro file here, or click to browse</p>
            <input type="file" id="fileInput" accept=".macro" style="display: none;">
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <!-- Execution Output -->
        <div class="executor-output" id="executorOutput"></div>

        <!-- Available Macros -->
        <div>
            <h2 style="margin: 2rem 0 1rem 0; color: var(--text-primary);">Available Macros</h2>
            <div class="macro-list" id="macroList">
                <!-- Macros will be populated here -->
            </div>
        </div>
    </div>

    <script>
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const macroList = document.getElementById('macroList');
        const executorOutput = document.getElementById('executorOutput');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');

        let uploadedMacros = [];

        // Load existing macros
        loadExistingMacros();

        // Upload zone click
        uploadZone.addEventListener('click', () => {
            fileInput.click();
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // Drag and drop
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('drag-over');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');

            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        // Handle uploaded file
        function handleFile(file) {
            if (!file.name.endsWith('.macro')) {
                alert('Please upload a .macro file');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const macro = parseMacro(file.name, content);
                uploadedMacros.push(macro);
                renderMacros();
                updateStats();

                // Show success message
                logOutput(`‚úì Macro uploaded: ${macro.name}`, 'success');
            };
            reader.readAsText(file);
        }

        // Parse macro file
        function parseMacro(filename, content) {
            const lines = content.split('\n');
            const commands = [];
            let description = '';

            for (let line of lines) {
                line = line.trim();

                // Skip empty lines
                if (!line) continue;

                // Parse comments for metadata
                if (line.startsWith('#')) {
                    if (line.includes('Name:')) {
                        description = line.split('Name:')[1].trim();
                    }
                    continue;
                }

                // Parse command
                commands.push(parseCommand(line));
            }

            return {
                name: filename.replace('.macro', ''),
                description: description || filename,
                commands: commands,
                content: content
            };
        }

        // Parse individual command
        function parseCommand(line) {
            const parts = line.split(' ', 2);
            const action = parts[0];
            const params = {};

            if (parts.length > 1) {
                const paramPairs = parts[1].split(' ');
                for (let pair of paramPairs) {
                    const [key, value] = pair.split('=');
                    if (key && value) {
                        params[key] = value;
                    }
                }
            }

            return { action, params };
        }

        // Load existing macros from server
        async function loadExistingMacros() {
            // In a real implementation, this would fetch from the server
            // For now, we'll just show placeholders
            const examples = [
                {
                    name: 'flange-design',
                    description: 'Mechanical Flange',
                    commands: []
                },
                {
                    name: 'propeller-design',
                    description: 'Drone Propeller',
                    commands: []
                },
                {
                    name: 'gear-design',
                    description: 'Spur Gear',
                    commands: []
                }
            ];

            uploadedMacros = examples;
            renderMacros();
            updateStats();
        }

        // Render macro list
        function renderMacros() {
            macroList.innerHTML = '';

            uploadedMacros.forEach(macro => {
                const card = document.createElement('div');
                card.className = 'macro-card';

                card.innerHTML = `
                    <div class="macro-info">
                        <h3>${macro.name}</h3>
                        <div class="macro-meta">
                            ${macro.description}
                            ${macro.commands.length > 0 ? ` ‚Ä¢ ${macro.commands.length} commands` : ''}
                        </div>
                    </div>
                    <div class="macro-actions">
                        <button class="btn btn-primary" onclick="runMacro('${macro.name}')">
                            ‚ñ∂ Run
                        </button>
                        <button class="btn btn-secondary" onclick="viewMacro('${macro.name}')">
                            üëÅ View
                        </button>
                    </div>
                `;

                macroList.appendChild(card);
            });
        }

        // Run macro
        async function runMacro(name) {
            const macro = uploadedMacros.find(m => m.name === name);
            if (!macro) return;

            executorOutput.classList.add('active');
            progressBar.classList.add('active');
            executorOutput.innerHTML = '';

            logOutput(`Starting macro: ${name}`, 'info');
            logOutput(`Commands: ${macro.commands.length}`, 'info');
            logOutput('', 'info');

            for (let i = 0; i < macro.commands.length; i++) {
                const cmd = macro.commands[i];
                const progress = ((i + 1) / macro.commands.length) * 100;
                progressFill.style.width = `${progress}%`;

                logOutput(`[${i + 1}/${macro.commands.length}] ${cmd.action}`, 'info');

                // Simulate command execution
                await sleep(200);

                // In real implementation, would execute actual commands
                logOutput(`  ‚úì Success`, 'success');
            }

            progressFill.style.width = '100%';
            logOutput('', 'info');
            logOutput(`‚úì Macro complete: ${name}`, 'success');

            setTimeout(() => {
                progressBar.classList.remove('active');
            }, 1000);
        }

        // View macro content
        function viewMacro(name) {
            const macro = uploadedMacros.find(m => m.name === name);
            if (!macro) return;

            executorOutput.classList.add('active');
            executorOutput.innerHTML = `
                <div style="color: var(--accent-primary); font-weight: 600; margin-bottom: 1rem;">
                    Macro: ${macro.name}
                </div>
                <pre style="margin: 0; color: var(--text-primary);">${escapeHtml(macro.content || 'No content available')}</pre>
            `;
        }

        // Log output
        function logOutput(message, type = 'info') {
            const line = document.createElement('div');
            line.className = `log-line log-${type}`;
            line.textContent = message;
            executorOutput.appendChild(line);
            executorOutput.scrollTop = executorOutput.scrollHeight;
        }

        // Update stats
        function updateStats() {
            document.getElementById('macroCount').textContent =
                `${uploadedMacros.length} Macro${uploadedMacros.length !== 1 ? 's' : ''} Loaded`;
        }

        // Utilities
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>